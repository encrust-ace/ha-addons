daemon off;
user root;
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;

    server {
        listen 8099;

        location / {
            proxy_pass http://127.0.0.1:8888/;
            # Force LedFx to send uncompressed data so NGINX can read and modify it
            proxy_set_header Accept-Encoding ""; 
            
            # 1. Rewrite the HTML attributes to prepend the Ingress path
            sub_filter 'href="/' 'href="$http_x_ingress_path/';
            sub_filter 'src="/' 'src="$http_x_ingress_path/';
            
            # 2. Catch Webpack dynamic chunk imports inside the JavaScript bundles
            sub_filter '"/static/' '"$http_x_ingress_path/static/';
            sub_filter '"/api/' '"$http_x_ingress_path/api/';
            
            # Apply the filter to both HTML and JavaScript files
            sub_filter_types text/html application/javascript;
            sub_filter_once off;

            # WebSocket support for the real-time UI
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}